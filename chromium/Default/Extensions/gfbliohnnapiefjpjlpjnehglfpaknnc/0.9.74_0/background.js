"use strict";function loadRawSettings(t,e,n){var o=n||{};chrome.storage.local.get(null,function(n){var r=n.savedAt||0;chrome.storage.sync.get(null,function(i){var a=i.savedAt||0;r>a?(extendObject(o,n),_save(chrome.storage.sync,n,function(){var n=getSubSettings(o,t);chrome.runtime.lastError&&(n.error="Settings sync may not work thoroughly because of: "+chrome.runtime.lastError.message),e(n)})):r<a?(extendObject(o,i),e(getSubSettings(o,t)),_save(chrome.storage.local,i)):(extendObject(o,n),e(getSubSettings(o,t)))})})}function _applyProxySettings(t){if(t.proxyMode&&"clear"!==t.proxyMode){var e=t.autoproxy_hosts.map(function(t){return t.filter(function(t){return t.indexOf("*")!==-1}).join("|")}),n=t.autoproxy_hosts.map(function(t){return dictFromArray(t.filter(function(t){return t.indexOf("*")===-1}),1)}),o={mode:["always","byhost","bypass"].indexOf(t.proxyMode)!==-1?"pac_script":t.proxyMode,pacScript:{data:"var pacGlobal = {\n                        hosts: ".concat(JSON.stringify(n),",\n                        autoproxy_pattern: ").concat(JSON.stringify(e),",\n                        proxyMode: '").concat(t.proxyMode,"',\n                        proxy: ").concat(JSON.stringify(t.proxy),'\n                    };\n                    function FindProxyForURL(url, host) {\n                        var lastPos;\n                        if (pacGlobal.proxyMode === "always") {\n                            return pacGlobal.proxy[0];\n                        } else if (pacGlobal.proxyMode === "bypass") {\n                            var pp = new RegExp(pacGlobal.autoproxy_pattern[0]);\n                            do {\n                                if (pacGlobal.hosts[0].hasOwnProperty(host)\n                                    || (pacGlobal.autoproxy_pattern[0].length && pp.test(host))) {\n                                    return "DIRECT";\n                                }\n                                lastPos = host.indexOf(\'.\') + 1;\n                                host = host.slice(lastPos);\n                            } while (lastPos >= 1);\n                            return pacGlobal.proxy[0];\n                        } else {\n                            for (var i = 0; i < pacGlobal.proxy.length; i++) {\n                                var pp = new RegExp(pacGlobal.autoproxy_pattern[i]);\n                                var ahost = host;\n                                do {\n                                    if (pacGlobal.hosts[i].hasOwnProperty(ahost)\n                                        || (pacGlobal.autoproxy_pattern[i].length && pp.test(ahost))) {\n                                        return pacGlobal.proxy[i];\n                                    }\n                                    lastPos = ahost.indexOf(\'.\') + 1;\n                                    ahost = ahost.slice(lastPos);\n                                } while (lastPos >= 1);\n                            }\n                            return "DIRECT";\n                        }\n                    }')}};chrome.proxy.settings.set({value:o,scope:"regular"},function(){})}else chrome.proxy.settings.clear({scope:"regular"})}function request(t,e,n,o,r){return n=n||{},new Promise(function(e,r){var i=new XMLHttpRequest,a=void 0!==o?"POST":"GET";i.open(a,t);for(var s in n)i.setRequestHeader(s,n[s]);i.onload=function(){200===i.status||0===i.status?e(i.responseText):r(i.status)},i.onerror=r.bind(null,i),i.send(o)}).then(e)["catch"](function(t){r&&r(t)})}function dictFromArray(t,e){var n={};return t.forEach(function(t){n[t]=e}),n}function extendObject(t,e){for(var n in e)t[n]=e[n]}function getSubSettings(t,e){var n;return e?(e instanceof Array||(e=[e]),n={},e.forEach(function(e){n[e]=t[e]})):n=t,n}function _save(t,e,n){t===chrome.storage.sync?(e.localPath&&delete e.snippets,t.set(e,n)):e.localPath?(delete e.snippets,request(e.localPath,function(o){e.snippets=o,t.set(e,n)})):t.set(e,n)}var Gist=function(){function t(t,e,n){request("https://api.github.com/gists",function(o){var r=JSON.parse(o),i="";r.forEach(function(t){t.hasOwnProperty("description")&&t.description===e&&t.files.hasOwnProperty(e)&&(i=t.id)}),""===i?request("https://api.github.com/gists",function(t){var e=JSON.parse(t);n(e.id)},{Authorization:"token "+t},'{ "description": "'.concat(e,'", "public": false, "files": { "').concat(e,'": { "content": "').concat(e,'" } } }')):n(i)},{Authorization:"token "+t})}function e(t,e){request("https://api.github.com/gists/".concat(s,"/comments"),function(t){e&&e(t)},{Authorization:"token "+i},'{"body": "'.concat(encodeURIComponent(t),'"}'))}function n(t,e){request("https://api.github.com/gists/".concat(s,"/comments/").concat(t),function(t){var n=JSON.parse(t);e({status:0,content:decodeURIComponent(n.body)})},{Authorization:"token "+i})}function o(t){request("https://api.github.com/gists/".concat(s,"/comments"),function(e){c=JSON.parse(e).map(function(t){return t.id}),t(c)},{Authorization:"token "+i})}function r(t,e,n){request("https://api.github.com/gists/".concat(s,"/comments/").concat(t),function(t){n&&n(t)},{Authorization:"token "+i},'{"body": "'.concat(encodeURIComponent(e),'"}'))}var i,a={},s="",c=[];return a.initGist=function(e,n){return i===e&&""!==s?s:(i=e,void t(i,"cloudboard",function(t){s=t,n&&n(s)}))},a.readComment=function(t,e){""===s?e({status:1,content:"Please call initGist first!"}):t>=c.length?o(function(o){t<o.length?n(o[t],e):e({status:1,content:"Register not exists!"})}):n(c[t],e)},a.editComment=function(t,n,i){""===s?i({status:1,content:"Please call initGist first!"}):t>=c.length?o(function(o){if(t<o.length)r(o[t],n,i);else{var a=function c(){s--,s>0?e(".",c):0===s&&e(n,i)},s=t-o.length+1;a()}}):r(c[t],n,i)},a}(),ChromeService=function(){function t(e,n){var o=n;if(""===e.title||e.hasOwnProperty("url")&&void 0!==e.url||(o+="/"+e.title,D.push({id:e.id,title:o+"/"})),e.hasOwnProperty("children"))for(var r=0;r<e.children.length;++r)t(e.children[r],o)}function e(t,n){t.path.length?chrome.bookmarks.create({parentId:t.folder,title:t.path.shift()},function(o){t.folder=o.id,e(t,n)}):chrome.bookmarks.create({parentId:t.folder,title:t.title,url:t.url},function(t){n(t)})}function n(t,e){var n={blacklist:{},marks:{},findHistory:[],cmdHistory:[],sessions:{},proxyMode:"clear",autoproxy_hosts:[],proxy:[]};loadRawSettings(t,function(t){"string"==typeof t.proxy&&(t.proxy=[t.proxy],t.autoproxy_hosts=[t.autoproxy_hosts]),t.localPath?request(t.localPath,function(n){t.snippets=n,e(t)},void 0,void 0,function(n){t.error="Failed to read snippets from "+t.localPath,e(t)}):e(t)},n)}function o(t){delete M[t],delete G[t],delete j[t],delete F[t],A=A.filter(function(e){return e!==t}),z.length&&chrome.tabs.create({active:!1,url:z.shift()}),f()}function r(t){if(G.hasOwnProperty(t)){var e=G[t];chrome.tabs.executeScript(t,{code:"_setScrollPos("+e.scrollLeft+", "+e.scrollTop+")"}),delete G[t]}}function i(t,e,n,o){e===-1?chrome.tabs.sendMessage(t,n):chrome.tabs.sendMessage(t,n,{frameId:e})}function a(t){W!==t&&(null!==W&&i(W,0,{subject:"tabDeactivated"}),i(t,0,{subject:"tabActivated"}),W=t)}function s(t){chrome.tabs.query({active:!0,currentWindow:!0},function(e){e.length>0&&t(e[0])})}function c(t,e,n){var o=E.pendingPorts.indexOf(t);o!==-1&&E.pendingPorts.splice(o,1),e(n)}function u(t,e){t.savedAt=(new Date).getTime(),_save(chrome.storage.local,t,function(){e&&e()}),_save(chrome.storage.sync,t,function(){if(chrome.runtime.lastError){chrome.runtime.lastError.message}})}function d(t){chrome.tabs.query({},function(e){e.forEach(function(e){i(e.id,-1,{subject:"settingsUpdated",settings:t})})})}function l(t,e){d(t),u(t,e)}function f(){B.showTabIndices&&chrome.tabs.query({currentWindow:!0},function(t){t.forEach(function(t){i(t.id,0,{subject:"tabIndexChange",index:t.index+1})})})}function h(t){return 0!==t.frameId&&"about:blank"===t.url?t.tab.url:t.url}function p(t,e,n){if(t.blacklist[".*"])return!0;if(e){if(t.blacklist[e.origin])return!0;if(n)return n=new RegExp(n.source,n.flags),n.test(e.href)}return!1}function m(t,e){request(t,function(n){l({localPath:t,snippets:n}),e({status:"Succeeded",snippets:n})},void 0,void 0,function(t){e({status:"Failed"})})}function b(t,e){return e&&e.length&&(t=t.filter(function(t){return t.title.indexOf(e)!==-1||t.url&&t.url.indexOf(e)!==-1})),t}function g(t,e){chrome.history.search({startTime:0,maxResults:2147483647,text:""},function(n){e&&(n=n.sort(function(t,e){return e.visitCount-t.visitCount})),t(n)})}function y(t,e){chrome.windows.update(t,{focused:!0},function(){chrome.tabs.update(e,{active:!0})})}function v(t,e){return t<0?t=0:t>=e&&(t=e),t}function w(t,e,n){return e>n-t&&(t-=e-(n-t)),t}function x(t,e){t?chrome.tabs.query({windowId:t.windowId},function(n){0==t.index&&e==-1?e=n.length-1:t.index==n.length-1&&1==e&&(e=1-n.length);var o=v(t.index+e,n.length-1);chrome.tabs.update(n[o].id,{active:!0})}):s(function(t){x(t,e)})}function k(t,e,n){t?chrome.tabs.query({windowId:t.windowId},function(o){var r=o.map(function(t){return t.id});e=v(e,o.length);var i=w(t.index,e,o.length);n(r.slice(i,i+e))}):s(function(t){k(t,e,n)})}function T(t,e){chrome.tabs.query({currentWindow:!0},function(n){n=n.map(function(t){return t.id}),chrome.tabs.remove(n.slice(t.tab.index+(e<0?e:1),t.tab.index+(e<0?0:1+e)))})}function I(t){return!/^view-source:|^javascript:/.test(t)&&/^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/\n]+)/im.test(t)&&(t=/^[\w-]+?:/i.test(t)?t:"http://"+t),t}function q(t,e,n){var o;if(t)switch(B.newTabPosition){case"left":o=t.index;break;case"right":o=t.index+1;break;case"first":o=0;break;case"last":break;default:o=t.index+1+_,_++}chrome.tabs.create({url:e,active:n.tab.active,index:o,pinned:n.tab.pinned,openerTabId:t.id},function(t){(n.scrollLeft||n.scrollTop)&&(G[t.id]={scrollLeft:n.scrollLeft,scrollTop:n.scrollTop})})}function P(){chrome.windows.getAll({populate:!1},function(t){t.forEach(function(t){chrome.windows.remove(t.id)})})}function O(t,e){n(["proxyMode","proxy","autoproxy_hosts"],function(n){if("deleteProxyPair"===t.operation)n.proxy.splice(t.number,1),n.autoproxy_hosts.splice(t.number,1);else if("set"===t.operation)n.proxyMode=t.mode,n.proxy=t.proxy,n.autoproxy_hosts=t.host;else if(t.mode&&(n.proxyMode=t.mode),t.number||(t.number=0),t.proxy&&(n.proxy[t.number]=t.proxy,n.autoproxy_hosts.length<=t.number&&(n.autoproxy_hosts[t.number]=[])),t.host){var o=dictFromArray(n.autoproxy_hosts[t.number],1),r=t.host.split(/\s*[ ,\n]\s*/);"toggle"===t.operation?r.forEach(function(t){o.hasOwnProperty(t)?delete o[t]:o[t]=1}):"add"===t.operation?r.forEach(function(t){o[t]=1}):r.forEach(function(t){delete o[t]}),n.autoproxy_hosts[t.number]=Object.keys(o)}var i={autoproxy_hosts:n.autoproxy_hosts,proxyMode:n.proxyMode,proxy:n.proxy};l(i),_applyProxySettings(n),e&&e(i)})}function S(t,e){var o=t[0],t=t.substr(1);"B"===o?chrome.bookmarks.remove(t,e):"H"===o?chrome.history.deleteUrl({url:t},e):"T"===o?(t=t.split(":").map(function(t){return parseInt(t)}),chrome.windows.update(t[0],{focused:!0},function(){chrome.tabs.remove(t[1],e)})):"M"===o&&n("marks",function(n){delete n.marks[t],l({marks:n.marks},e)})}function R(t,e){chrome.bookmarks.search({url:t},function(t){t.forEach(function(t){chrome.bookmarks.remove(t.id)}),e&&e()})}function L(t){for(var e=0;e<t.requestHeaders.length;++e)if("User-Agent"===t.requestHeaders[e].name){t.requestHeaders[e].value=J;break}return{requestHeaders:t.requestHeaders}}var E={},A=[],U=0,_=0,C=!1,M={},G={},F={},j={},H="chrome://newtab/",B={focusAfterClosed:"right",repeatThreshold:99,tabsMRUOrder:!0,newTabPosition:"default",showTabIndices:!1,interceptedErrors:[]},D=[];n(null,_applyProxySettings),chrome.tabs.onRemoved.addListener(o);var W=null;chrome.tabs.onUpdated.addListener(function(t,e,n){"loading"===e.status?delete F[t]:"complete"===e.status&&n.active&&a(t),r(t)}),chrome.windows.onFocusChanged.addListener(function(t){s(function(t){a(t.id)})}),chrome.tabs.onCreated.addListener(function(t){r(t.id),f()}),chrome.tabs.onMoved.addListener(function(){f()}),chrome.tabs.onActivated.addListener(function(t){C||t.tabId==A[A.length-1]||(A.length>10&&A.shift(),U!=A.length-1&&A.splice(U+1,A.length-1),A.push(t.tabId),U=A.length-1),M[t.tabId]=(new Date).getTime(),a(t.tabId),C=!1,_=0,r(t.tabId),f()}),chrome.tabs.onDetached.addListener(function(){f()}),chrome.tabs.onAttached.addListener(function(){f()}),chrome.commands.onCommand.addListener(function(t){switch(t){case"restartext":chrome.tabs.query({},function(t){t.forEach(function(t){chrome.tabs.reload(t.id)}),chrome.runtime.reload()});break;case"previousTab":case"nextTab":s(function(e){var n="previousTab"===t?e.index-1:e.index+1;chrome.tabs.query({windowId:e.windowId},function(t){n=(n%t.length+t.length)%t.length,chrome.tabs.update(t[n].id,{active:!0})})});break;case"closeTab":s(function(t){chrome.tabs.remove(t.id)});break;case"proxyThis":s(function(t){var e=new URL(t.url||t.pendingUrl).host;O({host:e,operation:"toggle"},function(){chrome.tabs.reload(t.id,{bypassCache:!0})})})}}),E.pendingPorts=[],chrome.runtime.onMessage.addListener(function(t,e,n){if(E.hasOwnProperty(t.action)){t.repeats>B.repeatThreshold&&(t.repeats=B.repeatThreshold);var o=E[t.action](t,e,n);if(t.needResponse)return o?(n(o),t.needResponse=!1):E.pendingPorts.push(t),t.needResponse}else console.log("[unexpected runtime message] "+JSON.stringify(t))}),E.toggleBlacklist=function(t,e,o){n("blacklist",function(n){var r=".*",i=e.origin||new URL(h(e)).origin;0!==chrome.extension.getURL("").indexOf(i)&&(r=i),n.blacklist.hasOwnProperty(r)?delete n.blacklist[r]:n.blacklist[r]=1,l({blacklist:n.blacklist},function(){o({disabled:p(n,e.tab?new URL(h(e)):null,t.blacklistPattern),blacklist:n.blacklist,url:r})})})},E.toggleMouseQuery=function(t,e,o){n("mouseSelectToQuery",function(n){if(e.tab&&0!==e.tab.url.indexOf(chrome.extension.getURL(""))){var o=n.mouseSelectToQuery||[],r=o.indexOf(t.origin);r===-1?o.push(t.origin):o.splice(r,1),l({mouseSelectToQuery:o})}})},E.getDisabled=function(t,e,o){n(["blacklist","noPdfViewer"],function(n){e.tab&&c(t,o,{noPdfViewer:n.noPdfViewer,disabled:p(n,new URL(h(e)),t.blacklistPattern)})})},E.addVIMark=function(t,e,o){n("marks",function(e){extendObject(e.marks,t.mark),l({marks:e.marks})})},E.jumpVIMark=function(t,e,o){n("marks",function(n){var i=n.marks;if(i.hasOwnProperty(t.mark)){var a=i[t.mark];chrome.tabs.query({},function(t){t=t.filter(function(t){return t.url===a.url}),0===t.length?(a.tab={tabbed:!0,active:!0},E.openLink(a,e,o)):((a.scrollLeft||a.scrollTop)&&(G[t[0].id]={scrollLeft:a.scrollLeft,scrollTop:a.scrollTop}),t[0].id===e.tab.id?r(t[0].id):chrome.tabs.update(t[0].id,{active:!0}))})}})},E.resetSettings=function(t,e,o){chrome.storage.local.clear(),chrome.storage.sync.clear(),n(null,function(e){_applyProxySettings(e),c(t,o,{settings:e}),d(e)})},E.loadSettingsFromUrl=function(t,e,n){m(t.url,function(e){c(t,n,e)})},E.getRecentlyClosed=function(t,e,n){chrome.sessions.getRecentlyClosed({},function(e){for(var o=[],r=0;r<e.length;r++){var i=e[r];i.hasOwnProperty("window")?o=o.concat(i.window.tabs):i.hasOwnProperty("tab")&&o.push(i.tab)}o=b(o,t.query),c(t,n,{urls:o})})},E.getTopSites=function(t,e,n){chrome.topSites.get(function(e){e=b(e,t.query),c(t,n,{urls:e})})},E.getAllURLs=function(t,e,n){chrome.bookmarks.getRecent(2147483647,function(e){var o=e;g(function(e){o=o.concat(e),c(t,n,{urls:o})},!0)})},E.getTabs=function(t,e,n){var o=e.tab,r=t.queryInfo||{};chrome.tabs.query(r,function(e){e=b(e,t.query),t.query&&t.query.length&&(e=e.filter(function(e){return e.title.indexOf(t.query)!==-1||e.url&&e.url.indexOf(t.query)!==-1})),e=e.filter(function(t){return t.id!==o.id}),B.tabsMRUOrder&&e.sort(function(t,e){var n=M[t.id],o=M[e.id];return isFinite(n)||isFinite(o)?isFinite(n)?isFinite(o)?o-n:-1:1:0}),c(t,n,{tabs:e})})},E.togglePinTab=function(t,e,n){s(function(t){return chrome.tabs.update(t.id,{pinned:!t.pinned})})},E.focusTab=function(t,e,n){void 0!==t.windowId&&e.tab.windowId!==t.windowId?y(t.windowId,t.tabId):chrome.tabs.update(t.tabId,{active:!0})},E.focusTabByIndex=function(t,e,n){var o=t.queryInfo||{};chrome.tabs.query(o,function(e){t.repeats>0&&t.repeats<=e.length&&chrome.tabs.update(e[t.repeats-1].id,{active:!0})})},E.goToLastTab=function(t,e,n){if(A.length>1){var o=A[A.length-2];chrome.tabs.update(o,{active:!0})}},E.historyTab=function(t,e,n){if(A.length>0){C=!0,t.hasOwnProperty("index")?U=(parseInt(t.index)+A.length)%A.length:(U+=t.backward?-1:1,U<0?U=0:U>=A.length&&(U=A.length-1));var o=A[U];chrome.tabs.update(o,{active:!0})}},E.nextTab=function(t,e,n){x(e.tab,t.repeats)},E.previousTab=function(t,e,n){x(e.tab,-t.repeats)},E.reloadTab=function(t,e,n){k(e.tab,t.repeats,function(e){e.forEach(function(e){chrome.tabs.reload(e,{bypassCache:t.nocache})})})},E.closeTab=function(t,e,n){k(e.tab,t.repeats,function(t){chrome.tabs.remove(t,function(){"left"===B.focusAfterClosed?x(e.tab,-1):"last"===B.focusAfterClosed&&E.historyTab({backward:!0})})})},E.closeTabLeft=function(t,e,n){T(e,-t.repeats)},E.closeTabRight=function(t,e,n){T(e,t.repeats)},E.closeTabsToLeft=function(t,e,n){T(e,-e.tab.index)},E.closeTabsToRight=function(t,e,n){chrome.tabs.query({currentWindow:!0},function(t){T(e,t.length-e.tab.index)})},E.tabOnly=function(t,e,n){chrome.tabs.query({currentWindow:!0},function(t){t=t.map(function(t){return t.id}).filter(function(t){return t!=e.tab.id}),chrome.tabs.remove(t)})},E.muteTab=function(t,e,n){var o=e.tab;chrome.tabs.update(o.id,{muted:!o.mutedInfo.muted})},E.openLast=function(t,e,n){chrome.sessions.restore()},E.duplicateTab=function(t,e,n){chrome.tabs.duplicate(e.tab.id,function(){t.active===!1&&chrome.tabs.update(e.tab.id,{active:!0})})};var V=-1;E.getWindows=function(t,e,n){chrome.tabs.query({currentWindow:!1},function(e){var o={};e.forEach(function(t){var e=o[t.windowId]||[];e.push({title:t.title,url:t.url}),o[t.windowId]=e}),c(t,n,{windows:Object.keys(o).map(function(t){return{id:t,tabs:o[t],isPreviousChoice:parseInt(t)===V}})})})},E.moveToWindow=function(t,e,n){t.windowId===-1?chrome.windows.create({tabId:e.tab.id}):chrome.tabs.move(e.tab.id,{windowId:t.windowId,index:-1},function(){y(t.windowId,e.tab.id)}),V=t.windowId},E.gatherWindows=function(t,e,n){var o=e.tab.windowId;chrome.tabs.query({currentWindow:!1},function(t){t.forEach(function(t){chrome.tabs.move(t.id,{windowId:o,index:-1})})})},E.gatherTabs=function(t,e,n){var o=e.tab.windowId;t.tabs.forEach(function(t){chrome.tabs.move(t.id,{windowId:o,index:-1})})},E.getBookmarkFolders=function(e,n,o){chrome.bookmarks.getTree(function(n){D=[],t(n[0],""),c(e,o,{folders:D})})},E.createBookmark=function(t,n,o){R(t.page.url,function(){e(t.page,function(e){c(t,o,{bookmark:e})})})},E.getBookmarks=function(t,e,n){t.parentId?chrome.bookmarks.getSubTree(t.parentId,function(e){var o=e[0].children;t.query&&t.query.length&&(o=o.filter(function(e){return e.title.indexOf(t.query)!==-1||e.url&&e.url.indexOf(t.query)!==-1})),c(t,n,{bookmarks:o})}):t.query&&t.query.length?chrome.bookmarks.search(t.query,function(e){c(t,n,{bookmarks:e})}):chrome.bookmarks.getTree(function(e){c(t,n,{bookmarks:e[0].children})})},E.getHistory=function(t,e,n){g(function(e){c(t,n,{history:e})},t.sortByMostUsed)},E.openLink=function(t,e,n){var o=I(t.url);o.startsWith("javascript:")?chrome.tabs.executeScript(e.tab.id,{code:o.substr(11)}):t.tab.tabbed?0!==e.frameId&&chrome.extension.getURL("pages/frontend.html")===e.url||!e.tab?s(function(e){q(e,o,t)}):q(e.tab,o,t):chrome.tabs.update({url:o,pinned:t.tab.pinned||e.tab.pinned},function(e){(t.scrollLeft||t.scrollTop)&&(G[e.id]={scrollLeft:t.scrollLeft,scrollTop:t.scrollTop})})},E.viewSource=function(t,e,n){t.url="view-source:"+e.tab.url,E.openLink(t,e,n)},E.getSettings=function(t,e,o){var r=n;"RAW"===t.key&&(r=loadRawSettings,t.key=""),r(t.key,function(e){c(t,o,{settings:e})})},E.updateSettings=function(t,e,n){if("snippets"===t.scope)for(var o in t.settings)B.hasOwnProperty(o)&&(B[o]=t.settings[o]);else l(t.settings)},E.setSurfingkeysIcon=function(t,e,n){chrome.browserAction.setIcon({path:t.status?"icons/48-x.png":"icons/48.png",tabId:e.tab?e.tab.id:void 0})},E.request=function(t,e,n){request(t.url,function(e){c(t,n,{text:e})},t.headers,t.data)},E.nextFrame=function(t,e,n){var o=e.tab.id;chrome.tabs.executeScript(o,{allFrames:!0,matchAboutBlank:!0,runAt:"document_start",code:"typeof(getFrameId) === 'function' && getFrameId()"},function(t){if(t=t.filter(function(t){return t}),t.length>0){var e=t[0];t.length>1&&(F.hasOwnProperty(o)||(F[o]=0),F[o]++,F[o]=F[o]%t.length,e=t[F[o]]),i(o,-1,{subject:"focusFrame",frameId:e})}})},E.moveTab=function(t,e,n){chrome.tabs.query({windowId:e.tab.windowId},function(n){var o=v(e.tab.index+t.step*t.repeats,n.length);chrome.tabs.move(e.tab.id,{index:o})})},E.quit=function(t,e,n){P()},E.createSession=function(t,e,o){n("sessions",function(e){chrome.tabs.query({},function(n){var o={};n.forEach(function(t){t&&void 0!==t.index&&(o.hasOwnProperty(t.windowId)||(o[t.windowId]=[]),t.url!==H&&o[t.windowId].push(t.url))});var r=[];for(var i in o)o[i].length&&r.push(o[i]);e.sessions[t.name]={},e.sessions[t.name].tabs=r,l({sessions:e.sessions},t.quitAfterSaved?P:void 0)})})},E.openSession=function(t,e,o){n("sessions",function(e){if(e.sessions.hasOwnProperty(t.name)){var n=e.sessions[t.name].tabs;n[0].forEach(function(t){chrome.tabs.create({url:t,active:!1,pinned:!1})});for(var o=1;o<n.length;o++){var r=n[o];chrome.windows.create({},function(t){r.forEach(function(e){chrome.tabs.create({windowId:t.id,url:e,active:!1,pinned:!1})})})}chrome.tabs.query({url:H},function(t){chrome.tabs.remove(t.map(function(t){return t.id}))})}})},E.deleteSession=function(t,e,o){n("sessions",function(e){delete e.sessions[t.name],l({sessions:e.sessions})})},E.closeDownloadsShelf=function(t,e,n){t.clearHistory?chrome.downloads.erase({urlRegex:".*"}):(chrome.downloads.setShelfEnabled(!1),chrome.downloads.setShelfEnabled(!0))},E.getDownloads=function(t,e,n){chrome.downloads.search(t.query,function(e){c(t,n,{downloads:e})})},E.download=function(t,e,n){chrome.downloads.download({url:t.url})},E.executeScript=function(t,e,n){chrome.tabs.executeScript(e.tab.id,{frameId:e.frameId,code:t.code,matchAboutBlank:!0,file:t.file},function(e){c(t,n,{response:e})})},E.tabURLAccessed=function(t,e,n){if(e.tab){var o=e.tab.id;return j.hasOwnProperty(o)||(j[o]={}),j[o][t.url]=t.title,{active:e.tab.active,index:B.showTabIndices?e.tab.index+1:0}}return{}},E.getTabURLs=function(t,e,n){var o=j[e.tab.id]||{};return o=Object.keys(o).map(function(t){return{url:t,title:o[t]}}),{urls:o}},E.getTopURL=function(t,e,n){return{url:e.tab?e.tab.url:""}},E.updateProxy=function(t,e,n){O(t,function(e){c(t,n,e)})},E.setZoom=function(t,e,n){var o=e.tab.id,r=t.zoomFactor*t.repeats;0==r?chrome.tabs.setZoom(o,1):chrome.tabs.getZoom(o,function(t){chrome.tabs.setZoom(o,t+r)})},E.removeURL=function(t,e,n){function o(){r++,r===i&&c(t,n,{response:"Done"})}var r=0,i=t.uid.length,a=t.uid;"string"==typeof t.uid&&(i=1,a=[t.uid]),a.forEach(function(t){S(t,o)})},E.localData=function(t,e,n){t.data.constructor===Object?(chrome.storage.local.set(t.data,function(){}),d(t.data)):chrome.storage.local.get(t.data,function(e){c(t,n,{data:e})})},E.captureVisibleTab=function(t,e,n){chrome.tabs.captureVisibleTab(null,{format:"png"},function(e){c(t,n,{dataUrl:e})})},E.getCaptureSize=function(t,e,n){var o=document.createElement("img");o.onload=function(){c(t,n,{width:o.width,height:o.height})},chrome.tabs.captureVisibleTab(null,{format:"png"},function(t){o.src=t})},E.deleteHistoryOlderThan=function(t,e,n){var o=t.days||0,r=t.hours||0;chrome.history.deleteRange({startTime:0,endTime:(new Date).getTime()-1e3*(86400*o+3600*r)},function(){})},E.removeBookmark=function(t,e,n){R(e.tab.url)},E.getBookmark=function(t,e,n){chrome.bookmarks.search({url:e.tab.url},function(e){c(t,n,{bookmarks:e})})},E.initGist=function(t,e,n){return Gist.initGist(t.token,function(e){c(t,n,{gist:e})})},E.readComment=function(t,e,n){Gist.readComment(t.index,function(e){c(t,n,e)})},E.editComment=function(t,e,n){Gist.editComment(t.index,t.content,function(e){c(t,n,{gistResp:e})})};var z=[];E.queueURLs=function(t,e,n){z=z.concat(t.urls)},E.getQueueURLs=function(t,e,n){return{queueURLs:z}},E.getVoices=function(t,e,n){chrome.tts.getVoices(function(e){c(t,n,{voices:e})})},E.read=function(t,e,n){var o=t.options||{};o.onEvent=function(o){"start"===o.type?c(t,n,{ttsEvent:o}):i(e.tab.id,-1,{subject:"onTtsEvent",ttsEvent:o})},chrome.tts.speak(t.content,o)},E.stopReading=function(t,e,n){chrome.tts.stop()},E.openIncognito=function(t,e,n){chrome.windows.create({url:t.url,incognito:!0})};var J;return E.setUserAgent=function(t,e,n){t.userAgent?(J=t.userAgent,chrome.webRequest.onBeforeSendHeaders.addListener(L,{urls:["<all_urls>"]},["blocking","requestHeaders"])):chrome.webRequest.onBeforeSendHeaders.removeListener(L),chrome.tabs.reload(e.tab.id)},chrome.runtime.setUninstallURL("http://brookhong.github.io/2018/01/30/why-did-you-uninstall-surfingkeys.html"),E}();