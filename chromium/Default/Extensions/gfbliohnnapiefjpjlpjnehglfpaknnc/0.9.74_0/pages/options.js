"use strict";function createMappingEditor(e){var t=ace.edit(e);t.mode="normal";var n=new Mode("mappingsEditor");return n.container=t.container,n.setValue=function(e,n){t.setValue(e,n)},n.getValue=function(){return t.getValue()},n.addEventListener("keydown",function(e){e.sk_suppressed=!0,!Mode.isSpecialKeyOf("<Esc>",e.sk_keyName)||"normal"!==t.mode||null!==t.state.cm.state.vim.status&&""!==t.state.cm.state.vim.status||(document.activeElement.blur(),n.exit())}),document.querySelector("#mappings textarea").onfocus=function(){setTimeout(function(){Hints.exit(),Insert.exit(),n.enter(0,!0)},10)},t.setTheme("ace/theme/chrome"),ace.config.loadModule("ace/ext/language_tools",function(e){ace.config.loadModule("ace/autocomplete",function(e){e.Autocomplete.startCommand.bindKey="Tab",e.Autocomplete.prototype.commands.Space=e.Autocomplete.prototype.commands.Tab,e.Autocomplete.prototype.commands.Tab=e.Autocomplete.prototype.commands.Down,e.Autocomplete.prototype.commands["Shift-Tab"]=e.Autocomplete.prototype.commands.Up}),t.setOptions({enableBasicAutocompletion:!0,enableLiveAutocompletion:!1,enableSnippets:!1})}),t.setKeyboardHandler("ace/keyboard/vim",function(){var e=t.state.cm;e.on("vim-mode-change",function(e){t.mode=e.mode}),e.constructor.Vim.defineEx("write","w",function(e,t){saveSettings()}),e.constructor.Vim.defineEx("quit","q",function(e,t){window.close()})}),t.getSession().setMode("ace/mode/javascript"),t.$blockScrolling=1/0,n}function renderAutoproxyHosts(e,t,n){function o(){_updateProxy({number:n,host:i.value,operation:"add"})}var a="For below hosts, above proxy will be used, click ‚ùå to remove one.";"bypass"===e.proxyMode&&(a="For below hosts, <b>NO</b> proxy will be used, click ‚ùå to remove one."),setSanitizedContent(t.querySelector(".autoproxy_hosts>h3"),a);var i=t.querySelector(".autoproxy_hosts>input"),r=i.value;i.value="";var s=e.autoproxy_hosts[n].sort().map(function(e){return"<div class='aphost'><span class='remove'>‚ùå</span><span class=\"".concat(e===r?"highlight":"",'">').concat(e,"</span></div>")}).join("");setSanitizedContent(t.querySelector(".autoproxy_hosts>div"),s);var c=t.querySelector(".autoproxy_hosts");c.querySelectorAll("div.aphost>span.remove").forEach(function(e){e.onclick=function(){var e=this.closest("div.aphost");RUNTIME("updateProxy",{number:n,host:e.querySelector("span:nth-child(2)").innerText,operation:"remove"},function(){e.remove()})}}),i.onkeyup=function(e){13===e.keyCode&&o()},t.querySelector(".autoproxy_hosts>button").onclick=o,t.querySelector(".deleteProxyPair").onclick=function(){_updateProxy({number:n,operation:"deleteProxyPair"})}}function renderProxyPair(e,t){function n(e){var n=i.value.replace(/\W+([0-9]+)$/,":$1");_updateProxy({number:t,proxy:a.value+" "+n})}var o=document.querySelector("div.proxyPair[number='".concat(t,"']"));null===o&&(o=createElementWithContent("div",document.getElementById("templateProxyPair").innerHTML.trim(),{"class":"proxyPair",number:t}),proxyGroup.insertBefore(o,addProxyPair));var a=o.querySelector(".proxy>select"),i=o.querySelector(".proxy>input");a.onchange=n,i.onblur=n;var r=e.split(/\s+/);return r.length>0?(a.value=r[0],i.value=r[1]):a.value="PROXY",o}function renderProxySettings(e){if(proxyModeSelect.value=e.proxyMode,proxyModeSelect.onchange=function(){_updateProxy({mode:this.value})},document.querySelectorAll("#proxyMode span[mode]").forEach(function(e){e.hide()}),document.querySelector("#proxyMode span[mode=".concat(e.proxyMode,"]")).show(),"always"===e.proxyMode||"byhost"===e.proxyMode||"bypass"===e.proxyMode){if(document.querySelectorAll("div.proxyPair").remove(),"always"===e.proxyMode){var t=renderProxyPair(e.proxy[0],0);t.querySelector(".autoproxy_hosts").hide(),addProxyPair.hide()}else e.proxy.forEach(function(t,n){var o=renderProxyPair(t,n);o.querySelector(".autoproxy_hosts").show(),renderAutoproxyHosts(e,o,n)}),addProxyPair.show();var n=document.querySelectorAll("div.deleteProxyPair");n.length>1?n.show():n.hide()}}function _updateProxy(e){RUNTIME("updateProxy",e,function(e){renderProxySettings(e)})}function showAdvanced(e){e?(basicMappingsDiv.hide(),advancedSettingDiv.show(),advancedTogglerDiv.setAttribute("checked","checked")):(basicMappingsDiv.show(),advancedSettingDiv.hide(),advancedTogglerDiv.removeAttribute("checked"))}function renderSettings(e){showAdvanced(e.showAdvanced),e.localPath&&(localPathInput.value=e.localPath,localPathSaved=e.localPath);var t=window.innerHeight/2;mappingsEditor.container.style.height=t+"px",defaultMappingsEditor.container.style.height=t+"px",e.snippets&&e.snippets.length?mappingsEditor.setValue(e.snippets,-1):mappingsEditor.setValue(sample,-1),renderProxySettings(e)}function getURIPath(e){return e.length&&!/^\w+:\/\/\w+/i.test(e)&&e.indexOf("file:///")===-1&&(e=e.replace(/\\/g,"/"),"/"===e[0]&&(e=e.substr(1)),e="file:///"+e),e}function saveSettings(){var e=mappingsEditor.getValue(),t=getURIPath(localPathInput.value.trim());t.length&&t!==localPathSaved?RUNTIME("loadSettingsFromUrl",{url:t},function(n){Front.showBanner(n.status+" to load settings from "+t,5e3),renderKeyMappings(n),n.snippets&&n.snippets.length?(localPathSaved=t,mappingsEditor.setValue(n.snippets,-1)):""===e&&mappingsEditor.setValue(sample,-1)}):(RUNTIME("updateSettings",{settings:{snippets:e,localPath:getURIPath(localPathInput.value)}}),Front.showBanner("Settings saved",1e3))}function evalInSandbox(e,t){var n=generateQuickGuid();document.getElementById("sandbox").contentWindow.postMessage({id:n,action:"evalInSandbox",code:e},"*"),t&&(_sanboxCallback[n]=t)}function renderKeyMappings(e){evalInSandbox(e.snippets,function(e){initL10n(function(t){var n=basicMappings.map(function(n,o){var a=n.origin;return e.settings.map.hasOwnProperty(n.origin)&&(a=e.settings.map[n.origin]),"<div>\n    <span class=annotation>".concat(t(n.annotation),'</span>\n    <span class=kbd-span><kbd origin="').concat(n.origin,'" new="').concat(a,'">').concat(a?htmlEncode(a):"üö´","</kbd></span>\n    </div>")});setSanitizedContent(basicMappingsDiv,n.join("")),basicMappingsDiv.querySelectorAll("kbd").forEach(function(e){e.onclick=function(){KeyPicker.enter(this)}})})})}var defaultMappingsEditor=ace.edit("defaultMappings");defaultMappingsEditor.setTheme("ace/theme/chrome"),defaultMappingsEditor.setKeyboardHandler("ace/keyboard/vim"),defaultMappingsEditor.getSession().setMode("ace/mode/javascript"),defaultMappingsEditor.container.hide(),defaultMappingsEditor.setReadOnly(!0),defaultMappingsEditor.container.style.background="#f1f1f1",defaultMappingsEditor.$blockScrolling=1/0;var mappingsEditor=null;window.navigator.userAgent.indexOf("Firefox")!==-1&&(document.querySelector("#proxySettings").style.display="none");var proxyModeSelect=document.querySelector("#proxyMode>select"),proxyGroup=document.getElementById("proxyMode").parentElement,addProxyPair=document.getElementById("addProxyPair");addProxyPair.onclick=function(){_updateProxy({number:document.querySelectorAll("div.proxyPair").length,proxy:"SOCKS5 127.0.0.1:1080"})};var basicMappingsDiv=document.getElementById("basicMappings"),advancedSettingDiv=document.getElementById("advancedSetting"),advancedTogglerDiv=document.getElementById("advancedToggler"),localPathSaved="",localPathInput=document.getElementById("localPath"),sample=document.getElementById("sample").innerHTML;RUNTIME("getSettings",null,function(e){mappingsEditor=createMappingEditor("mappings"),renderSettings(e.settings),"error"in e.settings&&Front.showBanner(e.settings.error,5e3)}),advancedTogglerDiv.onclick=function(){var e=this.checked;showAdvanced(e),RUNTIME("updateSettings",{settings:{showAdvanced:e}})},document.getElementById("resetSettings").onclick=function(){"Reset"===this.innerText?this.innerText="WARNING! This will clear all your settings. Click this again to continue.":RUNTIME("resetSettings",null,function(e){renderSettings(e.settings),renderKeyMappings(e.settings),Front.showBanner("Settings reset",1e3)})},document.querySelector(".infoPointer").onclick=function(){var e=document.getElementById(this.getAttribute("for"));"none"===e.style.display?e.style.display="":e.style.display="none"},document.getElementById("showDefaultSettings").onclick=function(){"none"!==defaultMappingsEditor.container.style.display?(defaultMappingsEditor.container.hide(),mappingsEditor.container.style.width="100%"):(httpRequest({url:chrome.extension.getURL("/pages/default.js")},function(e){defaultMappingsEditor.container.style.display="inline-block",defaultMappingsEditor.setValue(e.text,-1),defaultMappingsEditor.container.style.width="50%"}),mappingsEditor.container.style.width="50%")},document.getElementById("save_button").onclick=saveSettings;var basicMappings=["d","R","f","E","e","x","gg","j","/","n","r","k","S","C","on","G","v","i",";e","og","g0","t","<Ctrl-6>","yy","g$","D","ob","X","sg","cf","yv","yt","N","l","cc","$","yf","w","0","yg","ow","cs","b","om","ya","h","gU","W","B","F",";j"];basicMappings=basicMappings.map(function(e,t){return{origin:e,annotation:Normal.mappings.find(KeyboardUtils.encodeKeystroke(e)).meta.annotation}});var _sanboxCallback={};window.addEventListener("message",function(e){var t=e.data.action;switch(t){case"resultInSandbox":_sanboxCallback.hasOwnProperty(e.data.id)&&(_sanboxCallback[e.data.id](e.data.result),delete _sanboxCallback[e.data.id])}}),document.addEventListener("surfingkeys:userSettingsLoaded",function(e){renderKeyMappings(e.detail)});var KeyPicker=function(){function e(){var e=htmlEncode(n);e||(e="&nbsp;"),setSanitizedContent(document.getElementById("inputKey"),e)}var t=new Mode("KeyPicker"),n="",o=document.getElementById("keyPicker");t.addEventListener("keydown",function(i){if(27===i.keyCode)o.hide(),t.exit();else if(8===i.keyCode){var r=KeyboardUtils.encodeKeystroke(n);r=r.substr(0,r.length-1),n=KeyboardUtils.decodeKeystroke(r),e()}else if(13===i.keyCode){o.hide(),t.exit(),setSanitizedContent(a,""!==n?htmlEncode(n):"üö´"),a.setAttribute("new",n);var s=Array.from(basicMappingsDiv.querySelectorAll("kbd")),c=s.map(function(e){return e.getAttribute("origin")},{}),d=[],l=s.map(function(e,t){var n=e.getAttribute("new"),o=e.getAttribute("origin"),a=[];if(""===n)a.push('unmap("'.concat(o,'");'));else if(n&&n!==o){var i=c.indexOf(n);i!==-1&&t<i&&(a.push('map(">_'.concat(n,'", "').concat(n,'");')),d.push(n)),d.indexOf(o)===-1?a.push('map("'.concat(n,'", "').concat(o,'");')):a.push('map("'.concat(n,'", ">_').concat(o,'");'))}return a.join("\n")}).filter(function(e){return""!=e}).join("\n");RUNTIME("updateSettings",{settings:{snippets:l}})}else if(i.sk_keyName.length>1){var p=JSON.stringify({metaKey:i.metaKey,altKey:i.altKey,ctrlKey:i.ctrlKey,shiftKey:i.shiftKey,keyCode:i.keyCode,code:i.code,composed:i.composed,key:i.key},null,4);reportIssue("Unrecognized key event: ".concat(i.sk_keyName),p)}else n+=KeyboardUtils.decodeKeystroke(i.sk_keyName),e();i.sk_stopPropagation=!0});var a,i=t.enter;return t.enter=function(r){i.call(t),n=r.innerText,"üö´"===n&&(n=""),e(),o.show(),a=r},t}();