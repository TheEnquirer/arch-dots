"use strict";var AceEditor=function(){function e(){return u.getValue()!=c}function t(){document.activeElement.blur(),Front.hidePopup()}function n(){t();var e=a();Front.onEditorSaved?(Front.onEditorSaved(e),Front.onEditorSaved=void 0):Front.contentCommand({action:"ace_editor_saved",data:e})}function o(e){var t=/[^a-zA-Z_0-9\$\-\u00C0-\u1FFF\u2C00-\uD7FF\w]+/,n=e.split(t),o={};return n.forEach(function(e){e="sk_"+e,o.hasOwnProperty(e)?o[e]++:o[e]=1}),Object.keys(o).map(function(e){return e=e.substr(3),{caption:e,value:e,score:o[e],meta:"local"}})}function a(){var e=u.getValue();return"select"===y&&(e=u.session.getLine(u.selection.lead.row),e=e.match(/.*>< ([^<]*)$/),e=e?e[1]:""),e}function i(){var e=u.state.cm;e.mode="normal",e.on("vim-mode-change",function(t){e.mode=t.mode}),e.on("0-register-set",function(e){var t=document.activeElement;Clipboard.write(e.text),t.focus()});var o=e.constructor.Vim;o.defineEx("write","w",function(e,t){Front.contentCommand({action:"ace_editor_saved",data:a()})}),o.defineEx("wq","wq",function(e,t){s.onExit=n,s.exit(),u.state.cm.signal("vim-command-done","")}),o.map("<CR>",":wq","normal"),o.defineEx("bnext","bn",function(e,t){Front.contentCommand({action:"nextEdit",backward:!1})}),o.defineEx("bprevious","bp",function(e,t){Front.contentCommand({action:"nextEdit",backward:!0})}),o.defineEx("quit","q",function(e,n){s.onExit=t,s.exit(),u.state.cm.signal("vim-command-done","")}),Front.vimMappings.forEach(function(e){o.map.apply(o,e)});var i=u.getKeyboardHandler().defaultKeymap;return Front.vimKeyMap&&Front.vimKeyMap.length&&i.unshift.apply(i,Front.vimKeyMap),o}function r(){return u.$emacsModeHandler.addCommands({closeAndSave:{exec:function(e){s.onExit=n,s.exit()},readOnly:!0}}),u.$emacsModeHandler.bindKey("C-x C-s","closeAndSave"),u.$emacsModeHandler}var s=new Mode("AceEditor");document.getElementById("sk_editor").style.height="30%";var c,u=ace.edit("sk_editor"),l=function(){return{open:function(e,t,n){PassThrough.enter();var o=n.onClose;n.onClose=function(){PassThrough.exit(),o&&o()},u.state.cm.openDialog(e,function(e){t(e),n.onClose()},n)}}}();s.addEventListener("keydown",function(n){n.sk_suppressed=!0,!Mode.isSpecialKeyOf("<Esc>",n.sk_keyName)||u.completer&&u.completer.activated||("emacs"===runtime.conf.aceKeybindings?(s.onExit=t,s.exit()):"normal"!==u.state.cm.mode||u.state.cm.state.vim.status||(e()?l.open('<span style="font-family: monospace">Quit anyway? Y/n </span><input type="text"/>',function(e){"y"===e.toLowerCase()&&(s.onExit=t,s.exit())},{bottom:!0,value:"Y",onKeyDown:function(e,t,n){e.keyCode!==KeyboardUtils.keyCodes.enter&&e.keyCode!==KeyboardUtils.keyCodes.ESC||n()}}):(s.onExit=t,s.exit())))});var m;RUNTIME("getAllURLs",null,function(e){m=e.urls.map(function(e){var t=0,n=1;return e.hasOwnProperty("typedCount")&&(t=e.typedCount),e.hasOwnProperty("visitCount")&&(n=e.visitCount),{caption:e.url,value:e.url,score:10*t+n,meta:"local"}})});var d={identifierRegexps:[/.*/],getCompletions:function(e,t,n,o,a){a(null,m)}},p=null,f={getCompletions:function(e,t,n,a,i){p?i(null,p):Front.contentCommand({action:"getPageText"},function(e){p=o(e.data),i(null,p)})}};ace.config.loadModule("ace/ext/language_tools",function(e){u.language_tools=e,ace.config.loadModule("ace/autocomplete",function(e){e.Autocomplete.startCommand.bindKey="Tab",e.Autocomplete.prototype.commands.Space=e.Autocomplete.prototype.commands.Tab,e.Autocomplete.prototype.commands.Tab=e.Autocomplete.prototype.commands.Down,e.Autocomplete.prototype.commands["Shift-Tab"]=e.Autocomplete.prototype.commands.Up,e.FilteredList.prototype.filterCompletions=function(e,t){for(var n,o=[],a=t.toUpperCase(),i=0;n=e[i];i++){var r=n.value.toUpperCase();if(r){var s=r.indexOf(a),c=0;s!==-1&&(c|=Math.pow(2,t.length)-1<<s,n.matchMask=c,n.exactMatch=0,o.push(n))}}return o}}),u.setOptions({enableBasicAutocompletion:!0,enableLiveAutocompletion:!1,enableSnippets:!1})});var y;u.setTheme("ace/theme/chrome");var g=new Promise(function(e,t){var n=i;"emacs"===runtime.conf.aceKeybindings?n=r:runtime.conf.aceKeybindings="vim",u.setKeyboardHandler("ace/keyboard/"+runtime.conf.aceKeybindings,function(){e(n())})});return u.container.style.background="#f1f1f1",u.$blockScrolling=1/0,s.show=function(e){g.then(function(t){u.setValue(e.content,-1),c=e.content,u.container.querySelector("textarea").focus(),s.enter(),y=e.type,u.setFontSize(16),"ace/keyboard/emacs"===t.$id?("url"===e.type?(u.setOption("showLineNumbers",!1),u.language_tools.setCompleters([d]),u.container.style.height="30%"):"input"===e.type?(u.setOption("showLineNumbers",!1),u.language_tools.setCompleters([f]),u.container.style.height=""):(u.setOption("showLineNumbers",!0),u.language_tools.setCompleters([f]),u.container.style.height="30%"),u.setReadOnly("select"===e.type),setTimeout(function(){u.renderer.session.$undoManager.reset()},1)):(t.unmap("<CR>","insert"),t.unmap("<C-CR>","insert"),"url"===e.type?(t.map("<CR>",":wq","insert"),u.setOption("showLineNumbers",!1),u.language_tools.setCompleters([d]),u.container.style.height="30%"):"input"===e.type?(t.map("<CR>",":wq","insert"),u.setOption("showLineNumbers",!1),u.language_tools.setCompleters([f]),u.container.style.height="16px"):(t.map("<C-CR>",":wq","insert"),u.setOption("showLineNumbers",!0),u.language_tools.setCompleters([f]),u.container.style.height="30%"),u.setReadOnly("select"===e.type),t.map("<C-d>","<C-w>","insert"),t.exitInsertMode(u.state.cm),u.state.cm.setCursor(e.initial_line,0),u.state.cm.ace.renderer.scrollCursorIntoView(),setTimeout(function(){u.renderer.session.$undoManager.reset()},1),u.state.cm.ace.setOption("indentedSoftWrap",!1),u.state.cm.ace.setOption("wrap",!0))})},s}();